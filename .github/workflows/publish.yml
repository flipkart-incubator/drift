# This workflow will build a package using Maven and then publish it to GitHub packages when a release is created
# Publish to Maven Central with GPG-signed artifacts.
# Requires secrets: CENTRAL_USERNAME, CENTRAL_TOKEN, GPG_PRIVATE_KEY, GPG_PASSPHRASE

name: Publish Package to the Maven Central

on:
  workflow_dispatch:
  push:
    tags:
      - v*

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
      CENTRAL_TOKEN: ${{ secrets.CENTRAL_TOKEN }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'adopt'
          cache: 'maven'
          server-id: central
          server-username: CENTRAL_USERNAME
          server-password: CENTRAL_TOKEN
          settings-path: ${{ github.workspace }}

      - name: Set up GPG for signing
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --yes --pinentry-mode loopback --import
          # List secret keys so we can use the only key (or set gpg.keyid in Maven if you have multiple)
          gpg --list-secret-keys --keyid-format=long

      - name: Ensure SNAPSHOT revision for workflow_dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          REVISION=$(python3 <<'PY'
          import xml.etree.ElementTree as ET
          tree = ET.parse("pom.xml")
          ns = {"mvn": "http://maven.apache.org/POM/4.0.0"}
          revision = tree.findtext("mvn:properties/mvn:revision", namespaces=ns)
          if revision is None:
              raise SystemExit("Unable to locate <revision> in pom.xml")
          print(revision.strip())
          PY
          )
          echo "Detected revision: ${REVISION}"
          if [[ "${REVISION}" != *SNAPSHOT ]]; then
            echo "Error: workflow_dispatch runs are allowed only for SNAPSHOT revisions."
            exit 1
          fi
          echo "Revision ${REVISION} is a SNAPSHOT; continuing."

      - name: Build with Maven
        run: mvn -B package 

      - name: Build and publish to Maven Central (with GPG signing)
        run: mvn -B deploy -s $GITHUB_WORKSPACE/settings.xml
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

